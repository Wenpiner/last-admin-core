syntax = "proto3";

package core;

option go_package = "./core";

message IDRequest {
  uint64 id = 1;
}

message IDSRequest {
  repeated uint64 ids = 1;
}

message UUIDRequest {
  string id = 1;
}

message ID32Request {
  uint32 id = 1;
}

message ID32SRequest {
  repeated uint32 ids = 1;
}

message UUIDSRequest {
  repeated string ids = 1;
}

message StringRequest {
  string value = 1;
}

message EmptyRequest {}


message BaseResponse {
  string message = 1;
}

message BasePageRequest {
  uint32 page_number = 1;
  uint32 page_size = 2;
}

message BasePageResp {
  uint64 total = 1;
  uint32 page_number = 2;
  uint32 page_size = 3;
}

message ApiInfo {
  optional uint32 id = 1;
  optional int64 created_at = 2;
  optional int64 updated_at = 3;
  optional string name = 4;
  optional string method = 5;
  optional string path = 6;
  optional string description = 7;
  optional bool is_required = 8;
  optional string service_name = 9;
  optional string api_group = 10;
}



message ApiListRequest {
  // 分页信息
  BasePageRequest page = 1;
  // 服务名
  optional string service_name = 2;
  // API分组
  optional string api_group = 3;
  // 所属方法
  optional string method = 4;
  // 描述
  optional string description = 5;
  // 路径
  optional string path = 6;
}

message ApiListResponse {
  BasePageResp page = 1;
  repeated ApiInfo list = 2;
}

service ApiService {
  // 创建或更新API
  rpc CreateOrUpdateApi(ApiInfo) returns (ApiInfo);
  // 删除API
  rpc DeleteApi(ID32SRequest) returns (BaseResponse);
  // 获取API
  rpc GetApi(ID32Request) returns (ApiInfo);
  // 获取API列表
  rpc ListApi(ApiListRequest) returns (ApiListResponse);
}




message DictInfo {
  optional uint32 id = 1;
  optional int64 created_at = 2;
  optional int64 updated_at = 3;
  optional string name = 4;
  optional string code = 5;
  optional string description = 6;
  optional bool state = 7;
}

message DictListRequest {
  // 分页信息
  BasePageRequest page = 1;
  // 字典名
  optional string name = 2;
  // 字典编码
  optional string code = 3;
  // 描述
  optional string description = 4;
}

message DictListResponse {
  BasePageResp page = 1;
  repeated DictInfo list = 2;
}

message DictItemInfo {
  optional uint32 id = 1;
  optional int64 created_at = 2;
  optional int64 updated_at = 3;
  optional string label = 4;
  optional string value = 5;
  optional string color = 6;
  optional string css = 7;
  optional int32 sort_order = 8;
  optional string description = 9;
  optional bool state = 10;
  optional uint32 dict_type_id = 11;
}

message DictItemListRequest {
  // 分页信息
  BasePageRequest page = 1;
  // 字典ID
  optional uint32 dict_id = 2;
  // 字典子项标签
  optional string label = 3;
  // 字典子项值
  optional string value = 4;
}

message DictItemListResponse {
  BasePageResp page = 1;
  repeated DictItemInfo list = 2;
}

service DictService {
  // 创建或更新字典
  rpc CreateOrUpdateDict(DictInfo) returns (DictInfo);
  // 删除字典
  rpc DeleteDict(ID32Request) returns (BaseResponse);
  // 获取字典
  rpc GetDict(ID32Request) returns (DictInfo);
  // 获取字典列表
  rpc ListDict(DictListRequest) returns (DictListResponse);
  // 创建或更新字典子项
  rpc CreateOrUpdateDictItem(DictItemInfo) returns (DictItemInfo);
  // 删除字典子项
  rpc DeleteDictItem(ID32Request) returns (BaseResponse);
  // 获取字典子项
  rpc GetDictItem(ID32Request) returns (DictItemInfo);
  // 获取字典子项列表
  rpc ListDictItem(DictItemListRequest) returns (DictItemListResponse);
}

message RoleInfo {
  optional uint32 id = 1;
  optional int64 created_at = 2;
  optional int64 updated_at = 3;
  optional string role_name = 4;
  optional string role_code = 5;
  optional string description = 6;
  optional bool state = 7;
}

message RoleListRequest {
  // 分页信息
  BasePageRequest page = 1;
  // 角色名称
  optional string role_name = 2;
  // 角色编码
  optional string role_code = 3;
}

message RoleListResponse {
  BasePageResp page = 1;
  repeated RoleInfo list = 2;
}

message RoleMenuRequest {
  optional uint32 role_id = 1;
  repeated uint32 menu_ids = 2;
}

message RoleApiRequest {
  optional uint32 role_id = 1;
  repeated uint32 api_ids = 2;
}

message RoleMenuListResponse {
  repeated uint32 list = 1;
}

message RoleApiListResponse {
  repeated uint32 list = 1;
}

message RoleConfigurationGroupRequest {
  // 角色ID
  string role_value = 1;
  // 配置项分组
  repeated string configuration_groups = 2;
}

message RoleConfigurationGroupListResponse {
  repeated string list = 1;
}


service RoleService {
  // 创建或更新角色
  rpc CreateOrUpdateRole(RoleInfo) returns (RoleInfo);
  // 删除角色
  rpc DeleteRole(ID32Request) returns (BaseResponse);
  // 获取角色
  rpc GetRole(ID32Request) returns (RoleInfo);
  // 获取角色列表
  rpc ListRole(RoleListRequest) returns (RoleListResponse);
  // 通过值获取角色
  rpc GetRoleByValue(StringRequest) returns (RoleInfo);
  // 为角色分配菜单
  rpc AssignMenu(RoleMenuRequest) returns (BaseResponse);
  // 为角色分配API
  rpc AssignApi(RoleApiRequest) returns (BaseResponse);
  // 获取角色菜单
  rpc GetMenu(ID32Request) returns (RoleMenuListResponse);
  // 为角色分配配置项分组权限
  rpc AssignConfigurationGroup(RoleConfigurationGroupRequest) returns (RoleConfigurationGroupListResponse);
  // 获取角色配置项分组权限
  rpc GetConfigurationGroup(StringRequest) returns (RoleConfigurationGroupListResponse);
}


message MenuMeta {
  optional string title = 1;
  optional string icon = 2;
  optional bool is_hidden = 3;
  optional bool is_breadcrumb = 4;
  optional bool is_cache = 5;
  optional bool is_tab = 6;
  optional bool is_affix = 7;
  optional string link = 8;
  optional string frame_src = 9;

}

message MenuInfo {
  optional uint32 id = 1;
  optional int64 created_at = 2;
  optional int64 updated_at = 3;
  optional string menu_code = 4;
  optional string menu_name = 5;
  optional uint32 parent_id = 6;
  optional string menu_path = 7;
  optional bool state = 8;
  optional int32 sort = 9;
  optional string menu_type = 10;
  optional string description = 11;
  optional string component = 12;
  optional string redirect = 13;
  optional string service_name = 14;
  optional MenuMeta meta = 15;
  optional uint32 menu_level = 16;
  optional string permission = 17;

}

message MenuListRequest {
  // 分页信息
  BasePageRequest page = 1;
  // 菜单名称
  optional string menu_name = 2;
  // 菜单编码
  optional string menu_code = 3;
}

message MenuListResponse {
  BasePageResp page = 1;
  repeated MenuInfo list = 2;
}

message StringListResponse {
  repeated string list = 1;
}

service MenuService {
  // 创建或更新菜单
  rpc CreateOrUpdateMenu(MenuInfo) returns (MenuInfo);
  // 删除菜单
  rpc DeleteMenu(ID32Request) returns (BaseResponse);
  // 获取菜单
  rpc GetMenu(ID32Request) returns (MenuInfo);
  // 获取菜单列表
  rpc ListMenu(MenuListRequest) returns (MenuListResponse);
  // 通过角色查询菜单
  rpc ListMenuByRole(StringRequest) returns (MenuListResponse);
  // 获取角色对应的所有页面权限
  rpc ListPagePermissionByRole(StringRequest) returns (StringListResponse);
}

// 部门服务
message DepartmentInfo {
  optional uint32 id = 1;
  optional int64 created_at = 2;
  optional int64 updated_at = 3;
  optional string dept_name = 4;
  optional string dept_code = 5;
  optional uint32 parent_id = 6;
  optional int32 sort_order = 7;
  optional string leader_user_id = 8;
  optional bool state = 9;
  optional string description = 10;
  optional string lader_username = 11;
  optional string lader_phone = 12;
  optional string lader_email = 13;
}

message DepartmentListRequest {
  // 分页信息
  BasePageRequest page = 1;
  // 部门名称
  optional string dept_name = 2;
  // 部门编码
  optional string dept_code = 3;
}

message DepartmentListResponse {
  BasePageResp page = 1;
  repeated DepartmentInfo list = 2;
}
service DepartmentService {
  // 创建或更新部门
  rpc CreateOrUpdateDepartment(DepartmentInfo) returns (DepartmentInfo);
  // 删除部门
  rpc DeleteDepartment(ID32Request) returns (BaseResponse);
  // 获取部门
  rpc GetDepartment(ID32Request) returns (DepartmentInfo);
  // 获取部门列表
  rpc ListDepartment(DepartmentListRequest) returns (DepartmentListResponse);
}

message PositionInfo {
  optional uint32 id = 1;
  optional int64 created_at = 2;
  optional int64 updated_at = 3;
  optional string position_name = 4;
  optional string position_code = 5;
  optional int32 sort_order = 6;
  optional bool state = 7;
  optional string description = 8;
}

message PositionListRequest {
  // 分页信息
  BasePageRequest page = 1;
  // 岗位名称
  optional string position_name = 2;
  // 岗位编码
  optional string position_code = 3;
}

message PositionListResponse {
  BasePageResp page = 1;
  repeated PositionInfo list = 2;
}

service PositionService {
  // 创建或更新岗位
  rpc CreateOrUpdatePosition(PositionInfo) returns (PositionInfo);
  // 删除岗位
  rpc DeletePosition(ID32Request) returns (BaseResponse);
  // 获取岗位
  rpc GetPosition(ID32Request) returns (PositionInfo);
  // 获取岗位列表
  rpc ListPosition(PositionListRequest) returns (PositionListResponse);
}


message TotpInfo {
  optional string id = 1;
  optional int64 created_at = 2;
  optional int64 updated_at = 3;
  optional bool state = 4;
  optional bool is_verified = 5;
  optional int64 last_used_at = 6;
  optional string last_used_code = 7;
  optional string device_name = 8;
  optional string issuer = 9;
}


// 用户信息
message UserInfo {
  optional string id = 1;
  optional int64 created_at = 2;
  optional int64 updated_at = 3;
  optional string username = 4;
  optional string email = 5;
  optional string password_hash = 6;
  optional string full_name = 7;
  optional string mobile = 8;
  optional string avatar = 9;
  optional string user_description = 10;
  optional int64 last_login_at = 11;
  optional string last_login_ip = 12;
  optional bool state = 13;

  // 角色信息
  repeated uint32 role_ids = 14;
  repeated string role_values = 15;

  // 部门信息
  optional uint32 department_id = 16;

  // 岗位信息
  repeated uint32 position_ids = 17;


  optional string home_path = 18;

  // 角色名称,号分割
  repeated string role_names = 19;
  // 部门名称
  optional string department_name = 20;
  // 岗位名称,号分割
  repeated string position_names = 21;



  optional uint32 provider_id = 22;
  optional TotpInfo totp_info = 23;
}

message UserListRequest {
  // 分页信息
  BasePageRequest page = 1;
  // 用户名
  optional string username = 2;
  // 手机号
  optional string mobile = 3;
  // 邮箱
  optional string email = 4;
}

message UserListResponse {
  BasePageResp page = 1;
  repeated UserInfo list = 2;
}

// TOTP相关消息类型
message TotpSetupResponse {
  string secret_key = 1;
  string qr_code_content = 2;// 二维码内容，不是URL
  repeated string backup_codes = 3;
  string device_name = 4;
  string issuer = 5;// 发行者名称，用于TOTP应用显示
}

message VerifyTotpSetupRequest {
  string user_id = 1;
  string totp_code = 2;
  optional string device_name = 3;
}

message TotpSetupConfirmResponse {
  bool success = 1;
  string message = 2;
  repeated string backup_codes = 3;
}

message DisableTotpRequest {
  string user_id = 1;
}

message VerifyTotpCodeRequest {
  string user_id = 1;
  string totp_code = 2;
  optional string ip_address = 3;
  optional string user_agent = 4;
}

message VerifyTotpCodeResponse {
  bool is_valid = 1;
  string message = 2;
}

message TotpStatusResponse {
  bool state = 1;
  bool is_verified = 2;
  optional string device_name = 3;
  optional int64 last_used_at = 4;
  int32 backup_codes_count = 5;
}

message BackupCodesResponse {
  repeated string backup_codes = 1;
  string message = 2;
}

message UseBackupCodeRequest {
  string user_id = 1;
  string backup_code = 2;
  optional string ip_address = 3;
  optional string user_agent = 4;
}

message EnableTotpRequest {
  string user_id = 1;
  string domain = 2;
  string issuer = 3;
}

service UserService {
  // 创建用户
  rpc CreateUser(UserInfo) returns (UserInfo);

  // 更新用户
  rpc UpdateUser(UserInfo) returns (UserInfo);

  // 删除用户
  rpc DeleteUser(UUIDRequest) returns (BaseResponse);

  // 获取用户
  rpc GetUser(UUIDRequest) returns (UserInfo);

  // 获取用户列表
  rpc ListUser(UserListRequest) returns (UserListResponse);

  // 获取用户 - 用户用户名
  rpc GetUserByUsername(StringRequest) returns (UserInfo);

  // TOTP相关接口
  // 启用TOTP - 生成密钥和二维码
  rpc EnableTotp(EnableTotpRequest) returns (TotpSetupResponse);

  // 验证并确认TOTP设置
  rpc VerifyTotpSetup(VerifyTotpSetupRequest) returns (TotpSetupConfirmResponse);

  // 禁用TOTP
  rpc DisableTotp(DisableTotpRequest) returns (BaseResponse);

  // 验证TOTP代码（用于登录）
  rpc VerifyTotpCode(VerifyTotpCodeRequest) returns (VerifyTotpCodeResponse);

  // 获取用户TOTP状态
  rpc GetTotpStatus(UUIDRequest) returns (TotpStatusResponse);

  // 重新生成备用恢复码
  rpc RegenerateBackupCodes(UUIDRequest) returns (BackupCodesResponse);

  // 使用备用恢复码
  rpc UseBackupCode(UseBackupCodeRequest) returns (BaseResponse);
}


// Oauth Provider 服务
message OauthProviderInfo {
  optional uint32 id = 1;
  optional int64 created_at = 2;
  optional int64 updated_at = 3;
  optional string provider_name = 4;
  optional string provider_code = 5;
  optional string client_id = 6;
  optional string client_secret = 7;
  optional string redirect_uri = 8;
  optional string scopes = 9;
  optional string authorization_url = 10;
  optional string token_url = 11;
  optional string userinfo_url = 12;
  optional string logout_url = 13;
  optional uint32 auth_style = 14;
  optional bool state = 15;
}

message OauthProviderListRequest {
  // 分页信息
  BasePageRequest page = 1;
  // 提供商名称
  optional string provider_name = 2;
  // 提供商编码
  optional string provider_code = 3;
  // 状态
  optional bool state = 4;
}

message OauthProviderListResponse {
  BasePageResp page = 1;
  repeated OauthProviderInfo list = 2;
}

message OauthLoginRequest {
  string state = 1;
  string provider = 2;
}
message OauthRedirectResponse {
  string url = 1;
}

message OauthCallbackRequest {
  string code = 1;
  string state = 2;
}

service OauthProviderService {
  // 创建或更新提供商
  rpc CreateOrUpdateOauthProvider(OauthProviderInfo) returns (OauthProviderInfo);
  // 删除提供商
  rpc DeleteOauthProvider(ID32Request) returns (BaseResponse);
  // 获取提供商
  rpc GetOauthProvider(ID32Request) returns (OauthProviderInfo);
  // 获取提供商列表
  rpc ListOauthProvider(OauthProviderListRequest) returns (OauthProviderListResponse);

  // Oauth Login
  rpc OauthLogin(OauthLoginRequest) returns (OauthRedirectResponse);

  // Oauth Callback
  rpc OauthCallback(OauthCallbackRequest) returns (UserInfo);
}


// Token信息
message TokenInfo {
  optional uint32 id = 1;
  optional int64 created_at = 2;
  optional int64 updated_at = 3;
  optional bool state = 5;
  optional string token_value = 6;
  optional string token_type = 7;
  optional string user_id = 8;
  optional int64 expires_at = 9;
  optional string device_info = 10;
  optional string ip_address = 11;
  optional int64 last_used_at = 12;
  optional string user_agent = 13;
  optional string metadata = 14;
  optional uint32 provider_id = 15;
  optional string username = 16;
  optional string provider_name = 17;
  optional string full_name = 18;
}

// Token列表请求
message TokenListRequest {
  // 分页信息
  BasePageRequest page = 1;
  // 用户ID
  optional string user_id = 2;
  // Token类型
  optional string token_type = 3;
  // IP地址
  optional string ip_address = 4;
  // 设备信息
  optional string device_info = 5;
  // 提供商ID
  optional uint32 provider_id = 6;
}

// Token列表响应
message TokenListResponse {
  BasePageResp page = 1;
  repeated TokenInfo list = 2;
}

// 创建Token请求
message CreateTokenRequest {
  string token_value = 1;
  string token_type = 2;
  optional string user_id = 3;
  int64 expires_at = 4;
  optional string device_info = 5;
  optional string ip_address = 6;
  optional string user_agent = 7;
  optional string metadata = 8;
  optional uint32 provider_id = 9;
}






// 清理过期Token请求
message CleanExpiredTokensRequest {
  optional string token_type = 1;// 如果不指定，则清理所有类型的过期token
  optional int64 before_time = 2;// 清理指定时间之前的token，如果不指定则清理所有过期token
}

// 清理过期Token响应
message CleanExpiredTokensResponse {
  int64 cleaned_count = 1;
  string message = 2;
}

// 更新Token最后使用时间请求
message UpdateTokenLastUsedRequest {
  string token_value = 1;
  optional string ip_address = 2;
}


// Token服务
service TokenService {
  // 创建Token
  rpc CreateToken(CreateTokenRequest) returns (TokenInfo);

  // 根据Token值获取Token信息
  rpc GetTokenByValue(StringRequest) returns (TokenInfo);

  // 更新Token
  rpc UpdateToken(TokenInfo) returns (TokenInfo);

  // 删除Token
  rpc DeleteToken(ID32Request) returns (BaseResponse);


  // 获取Token列表
  rpc ListToken(TokenListRequest) returns (TokenListResponse);

  // 清理过期Token
  rpc CleanExpiredTokens(CleanExpiredTokensRequest) returns (CleanExpiredTokensResponse);

  // 更新Token最后使用时间
  rpc UpdateTokenLastUsed(UpdateTokenLastUsedRequest) returns (BaseResponse);

}


// 初始化服务
service InitService {
  rpc Init(EmptyRequest) returns (BaseResponse);
}

message ConfigurationInfo {
  string key = 1;
  string value = 2;
  string name = 3;
  string group = 4;
  optional string description = 5;
}

message ConfigurationListRequest {
  BasePageRequest page = 1;
  optional string key = 2;
  optional string name = 3;
  optional string group = 4;
}

message ConfigurationListResponse {
  BasePageResp page = 1;
  repeated ConfigurationInfo list = 2;
}

message ValidateConfigurationRequest {
  string key = 1;
  // cel 表达式，用于验证配置值
  string exp = 2;
  optional string error_message = 3;
}

message ValidateConfigurationResponse {
  bool is_valid = 1;
  string message = 2;
}

// Configuration 服务
service ConfigurationService {
  rpc GetConfiguration(StringRequest) returns (ConfigurationInfo);
  rpc ListConfiguration(ConfigurationListRequest) returns (ConfigurationListResponse);
  rpc CreateOrUpdateConfiguration(ConfigurationInfo) returns (ConfigurationInfo);
  rpc DeleteConfiguration(StringRequest) returns (BaseResponse);
  // 验证某个配置的值是否有效
  rpc ValidateConfiguration(ValidateConfigurationRequest) returns (ValidateConfigurationResponse);
}


// 记录操作日志
message OperationLogInfo {
  optional uint32 id = 1;
  optional int64 created_at = 2;
  optional int64 updated_at = 3;
  optional string user_id = 4;
  optional string username = 5;
  optional string operation_type = 6;
  optional string module = 7;
  optional string business_type = 8;
  optional string method = 9;
  optional string request_url = 10;
  optional string request_params = 11;
  optional string response_data = 12;
  optional string ip_address = 13;
  optional string user_agent = 14;
  optional string location = 15;
  optional bool is_success = 16;
  optional string error_message = 17;
  optional int32 execution_time = 18;
  optional string description = 19;
}

message TimeRangeQuery {
  optional string start_time = 1;
  optional string end_time = 2;
}

message OperationLogListRequest {
  BasePageRequest page = 1;
  optional string user_id = 2;
  optional string username = 3;
  optional string operation_type = 4;
  optional string module = 5;
  optional string business_type = 6;
  optional string method = 7;
  optional string request_url = 8;
  optional string request_params = 9;
  optional string response_data = 10;
  optional string ip_address = 11;
  optional string user_agent = 12;
  optional string location = 13;
  optional bool is_success = 14;
  optional TimeRangeQuery execution_time = 15;
}

message OperationLogListResponse {
  BasePageResp page = 1;
  repeated OperationLogInfo list = 2;
}

service OperationLogService {
  rpc CreateOperationLog(OperationLogInfo) returns (BaseResponse);
  rpc ListOperationLog(OperationLogListRequest) returns (OperationLogListResponse);
}
