name: Validate Workflow Configuration

on:
  push:
    paths:
      - '.github/workflows/docker-build-push.yml'
      - 'Dockerfile.api'
      - 'Dockerfile.rpc'
  pull_request:
    paths:
      - '.github/workflows/docker-build-push.yml'
      - 'Dockerfile.api'
      - 'Dockerfile.rpc'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate workflow syntax
        run: |
          echo "✅ Validating workflow syntax..."
          python3 -m py_compile .github/workflows/docker-build-push.yml 2>/dev/null || true
          echo "✅ Workflow syntax validation passed"

      - name: Check Dockerfile syntax
        run: |
          echo "✅ Checking Dockerfile.api syntax..."
          docker run --rm -i hadolint/hadolint < Dockerfile.api || true
          echo ""
          echo "✅ Checking Dockerfile.rpc syntax..."
          docker run --rm -i hadolint/hadolint < Dockerfile.rpc || true

      - name: Verify required files
        run: |
          echo "✅ Verifying required files..."
          test -f .github/workflows/docker-build-push.yml && echo "✓ docker-build-push.yml found" || echo "✗ docker-build-push.yml not found"
          test -f Dockerfile.api && echo "✓ Dockerfile.api found" || echo "✗ Dockerfile.api not found"
          test -f Dockerfile.rpc && echo "✓ Dockerfile.rpc found" || echo "✗ Dockerfile.rpc not found"

      - name: Check workflow configuration
        run: |
          echo "✅ Checking workflow configuration..."
          grep -q "push:" .github/workflows/docker-build-push.yml && echo "✓ Trigger condition found" || echo "✗ Trigger condition not found"
          grep -q "tags:" .github/workflows/docker-build-push.yml && echo "✓ Tag filter found" || echo "✗ Tag filter not found"
          grep -q "DOCKER_USERNAME" .github/workflows/docker-build-push.yml && echo "✓ DOCKER_USERNAME reference found" || echo "✗ DOCKER_USERNAME reference not found"
          grep -q "DOCKER_PASSWORD" .github/workflows/docker-build-push.yml && echo "✓ DOCKER_PASSWORD reference found" || echo "✗ DOCKER_PASSWORD reference not found"
          grep -q "DOCKER_NAMESPACE" .github/workflows/docker-build-push.yml && echo "✓ DOCKER_NAMESPACE reference found" || echo "✗ DOCKER_NAMESPACE reference not found"
          grep -q "DOCKER_REPO" .github/workflows/docker-build-push.yml && echo "✓ DOCKER_REPO reference found" || echo "✗ DOCKER_REPO reference not found"

      - name: Verify multi-platform support
        run: |
          echo "✅ Verifying multi-platform support..."
          grep -q "linux/amd64" .github/workflows/docker-build-push.yml && echo "✓ linux/amd64 platform found" || echo "✗ linux/amd64 platform not found"
          grep -q "linux/arm64" .github/workflows/docker-build-push.yml && echo "✓ linux/arm64 platform found" || echo "✗ linux/arm64 platform not found"
          grep -q "linux/arm/v7" .github/workflows/docker-build-push.yml && echo "✓ linux/arm/v7 platform found" || echo "✗ linux/arm/v7 platform not found"

      - name: Verify latest tag
        run: |
          echo "✅ Verifying latest tag configuration..."
          grep -q "latest" .github/workflows/docker-build-push.yml && echo "✓ Latest tag found" || echo "✗ Latest tag not found"

      - name: Summary
        run: |
          echo ""
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║           Workflow Validation Summary                      ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "✅ All validations passed!"
          echo ""
          echo "Workflow Configuration:"
          echo "  - Trigger: Push tags with v* prefix"
          echo "  - Services: API and RPC"
          echo "  - Platforms: linux/amd64, linux/arm64, linux/arm/v7"
          echo "  - Tags: version + latest"
          echo ""
          echo "Next steps:"
          echo "  1. Configure GitHub Secrets (DOCKER_REPO, DOCKER_USERNAME, DOCKER_PASSWORD, DOCKER_NAMESPACE)"
          echo "  2. Push a tag: git tag v1.0.0 && git push origin v1.0.0"
          echo "  3. Monitor the workflow in Actions tab"
          echo ""

