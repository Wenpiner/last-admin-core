name: Docker Build and Push

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: docker.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - api
          - rpc
    permissions:
      contents: read
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
          echo "Tag: ${TAG}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.${{ matrix.service }}
          # TODO: åŽæœŸéœ€è¦æ”¯æŒå¤šå¹³å°æ—¶ï¼Œå–æ¶ˆæ³¨é‡Šä»¥ä¸‹è¡Œ
          # platforms: linux/amd64,linux/arm64,linux/arm/v7
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKER_REPO }}/${{ secrets.DOCKER_NAMESPACE }}/last-admin-${{ matrix.service }}:${{ steps.version.outputs.version }}
            ${{ secrets.DOCKER_REPO }}/${{ secrets.DOCKER_NAMESPACE }}/last-admin-${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image digest
        run: echo ${{ steps.docker_build.outputs.digest }}

  create-release:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Create deploy.tar.gz
        run: |
          tar -czf deploy.tar.gz deploy/
          ls -lh deploy.tar.gz

          # è®¡ç®— SHA256
          SHA256=$(sha256sum deploy.tar.gz | awk '{print $1}')
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
        id: deploy_package

      - name: Generate Release Notes
        id: release_notes
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TAG=${{ steps.version.outputs.tag }}
          SHA256=${{ steps.deploy_package.outputs.sha256 }}

          cat > release_notes.md << 'EOF'
          # Last Admin ${{ steps.version.outputs.tag }}

          ## ðŸ³ Docker é•œåƒ

          ### é•œåƒä¿¡æ¯
          - **API é•œåƒ**: `${{ secrets.DOCKER_REPO }}/${{ secrets.DOCKER_NAMESPACE }}/last-admin-api:${{ steps.version.outputs.version }}`
          - **RPC é•œåƒ**: `${{ secrets.DOCKER_REPO }}/${{ secrets.DOCKER_NAMESPACE }}/last-admin-rpc:${{ steps.version.outputs.version }}`
          - **Latest æ ‡ç­¾**: `${{ secrets.DOCKER_REPO }}/${{ secrets.DOCKER_NAMESPACE }}/last-admin-api:latest`

          ### æ‹‰å–é•œåƒ

          ```bash
          # æ‹‰å– API é•œåƒ
          docker pull ${{ secrets.DOCKER_REPO }}/${{ secrets.DOCKER_NAMESPACE }}/last-admin-api:${{ steps.version.outputs.version }}

          # æ‹‰å– RPC é•œåƒ
          docker pull ${{ secrets.DOCKER_REPO }}/${{ secrets.DOCKER_NAMESPACE }}/last-admin-rpc:${{ steps.version.outputs.version }}

          # æˆ–ä½¿ç”¨ latest æ ‡ç­¾
          docker pull ${{ secrets.DOCKER_REPO }}/${{ secrets.DOCKER_NAMESPACE }}/last-admin-api:latest
          docker pull ${{ secrets.DOCKER_REPO }}/${{ secrets.DOCKER_NAMESPACE }}/last-admin-rpc:latest
          ```

          ## ðŸ“¦ éƒ¨ç½²è„šæœ¬

          éƒ¨ç½²è„šæœ¬å·²æ‰“åŒ…ä¸º `deploy.tar.gz`ï¼ŒåŒ…å«ï¼š
          - `install.sh` - å®‰è£…è„šæœ¬
          - `install.py` - Python å®‰è£…å‘å¯¼
          - `lib/` - ä¾èµ–åº“
          - `templates/` - é…ç½®æ¨¡æ¿

          ### æ–‡ä»¶æ ¡éªŒ

          **SHA256**: `${{ steps.deploy_package.outputs.sha256 }}`

          éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
          ```bash
          echo "${{ steps.deploy_package.outputs.sha256 }}  deploy.tar.gz" | sha256sum -c
          ```

          ### å¿«é€Ÿå®‰è£…

          ```bash
          # æ–¹å¼ 1: ä½¿ç”¨ bootstrap è„šæœ¬ï¼ˆæŽ¨èï¼‰
          curl -fsSL https://raw.githubusercontent.com/Wenpiner/last-admin-core/main/install-bootstrap.sh | bash

          # æ–¹å¼ 2: æ‰‹åŠ¨ä¸‹è½½å’Œå®‰è£…
          tar -xzf deploy.tar.gz
          cd deploy
          chmod +x install.sh
          ./install.sh
          ```

          ## ðŸš€ å¯åŠ¨æœåŠ¡

          ```bash
          # è¿›å…¥å®‰è£…ç›®å½•
          cd /opt/last-admin

          # å¯åŠ¨æœåŠ¡
          docker compose up -d

          # æŸ¥çœ‹æ—¥å¿—
          docker compose logs -f

          # åœæ­¢æœåŠ¡
          docker compose down
          ```

          ## ðŸ“ æ›´æ–°æ—¥å¿—

          è¯¦è§ [CHANGELOG](https://github.com/Wenpiner/last-admin-core/blob/main/CHANGELOG.md)
          EOF

          cat release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          body_path: release_notes.md
          files: |
            deploy.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

